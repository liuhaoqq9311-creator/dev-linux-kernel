name: Sync stable as wrapper commits + tags

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Stable version to sync (e.g. 6.18.4)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (full history on runner)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream and force-fetch upstream tag (overwrite local tag)
        run: |
          set -euo pipefail
          git remote add upstream https://github.com/gregkh/linux.git || true
      
          # 强制把 upstream 的 vX.Y.Z 写到本地同名 tag（即使本地已存在也覆盖）
          git fetch --no-tags --force upstream "refs/tags/v${{ inputs.version }}:refs/tags/v${{ inputs.version }}"
      
          # 打印一下确认当前本地 vX.Y.Z 现在确实是 upstream 的那个 commit
          git show -s --oneline "v${{ inputs.version }}"

      - name: Fetch origin branch (optional)
        run: |
          # 如果远端还没有 linux-6.18.y，不让它失败
          git fetch origin linux-6.18.y:refs/remotes/origin/linux-6.18.y || true

      - name: Create wrapper commit (tree identical to upstream tag)
        run: |
          set -euo pipefail

          VERSION="${{ inputs.version }}"
          UP_TAG="v${VERSION}"
          COMMIT_MSG="linux-${VERSION}"

          UP_COMMIT="$(git rev-parse "${UP_TAG}^{commit}")"
          UP_TREE="$(git rev-parse "${UP_COMMIT}^{tree}")"

          if git show-ref --verify --quiet refs/remotes/origin/linux-6.18.y; then
            PARENT="$(git rev-parse refs/remotes/origin/linux-6.18.y)"
            NEW_COMMIT="$(git commit-tree "${UP_TREE}" -p "${PARENT}" -m "${COMMIT_MSG}")"
          else
            NEW_COMMIT="$(git commit-tree "${UP_TREE}" -m "${COMMIT_MSG}")"
          fi

          echo "Upstream tag commit: ${UP_COMMIT}"
          echo "New wrapper commit:  ${NEW_COMMIT}"

          git update-ref refs/heads/linux-6.18.y "${NEW_COMMIT}"

          # 关键：在 wrapper commit 上创建/更新同名 tag（轻量 tag）
          git tag -a -f "${UP_TAG}" -m "Linux ${VERSION}" "${NEW_COMMIT}"

      - name: Push branch and tag
        run: |
          set -euo pipefail
          # 推分支
          git push origin refs/heads/linux-6.18.y:refs/heads/linux-6.18.y --force
          # 推 tag（需要 --force，因为可能重复跑覆盖）
          git push origin "refs/tags/v${{ inputs.version }}:refs/tags/v${{ inputs.version }}" --force
